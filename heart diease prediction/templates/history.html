<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart Disease Prediction - History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="bi bi-clock-history"></i> Prediction History</h1>
            <p>Record of previous heart disease risk predictions</p>
        </div>
        
        <ul class="nav nav-pills mb-4 justify-content-center">
            <li class="nav-item">
                <a class="nav-link" href="/"><i class="bi bi-calculator"></i> Prediction Tool</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/visualizations"><i class="bi bi-graph-up"></i> Data Insights</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/history"><i class="bi bi-clock-history"></i> History</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/about"><i class="bi bi-info-circle"></i> About</a>
            </li>
        </ul>
        
        <div class="content-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="bi bi-list-check"></i> Prediction Records</h3>
                <div>
                    <button class="btn btn-outline-danger" id="clearHistoryBtn">
                        <i class="bi bi-trash"></i> Clear History
                    </button>
                </div>
            </div>
            
            {% if error %}
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error: {{ error }}
            </div>
            {% endif %}
            
            {% if history and history|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-danger">
                            <tr>
                                <th>Date & Time</th>
                                <th>Age</th>
                                <th>Sex</th>
                                <th>Key Risk Factors</th>
                                <th>Prediction</th>
                                <th>Probability</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in history|reverse %}
                            <tr>
                                <td>{{ record.timestamp }}</td>
                                <td>{{ record.input_data.age }}</td>
                                <td>{{ "Male" if record.input_data.sex == 1 else "Female" }}</td>
                                <td>
                                    <ul class="list-unstyled mb-0">
                                        {% if record.input_data.is_smoking == 1 %}
                                            <li><span class="badge bg-danger">Smoker</span></li>
                                        {% endif %}
                                        {% if record.input_data.prevalentHyp == 1 %}
                                            <li><span class="badge bg-danger">Hypertension</span></li>
                                        {% endif %}
                                        {% if record.input_data.diabetes == 1 %}
                                            <li><span class="badge bg-danger">Diabetes</span></li>
                                        {% endif %}
                                        {% if record.input_data.prevalentStroke == 1 %}
                                            <li><span class="badge bg-danger">Previous Stroke</span></li>
                                        {% endif %}
                                    </ul>
                                </td>
                                <td>
                                    {% if record.prediction == 1 %}
                                        <span class="badge bg-danger">High Risk</span>
                                    {% else %}
                                        <span class="badge bg-success">Low Risk</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar {% if record.prediction == 1 %}bg-danger{% else %}bg-success{% endif %}" 
                                             role="progressbar" 
                                             style="width: {% if record.probability %}{{ (record.probability * 100)|round(1, 'common') }}{% else %}0{% endif %}%;" 
                                             aria-valuenow="{% if record.probability %}{{ (record.probability * 100)|round(1, 'common') }}{% else %}0{% endif %}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {% if record.probability %}{{ (record.probability * 100)|round(1, 'common') }}{% else %}0{% endif %}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary view-details-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#recordDetailsModal"
                                            data-record='{{ record|tojson }}'>
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No prediction history found. Make a prediction to see it here.
                </div>
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-danger">
                        <i class="bi bi-calculator"></i> Make a Prediction
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Record Details Modal -->
    <div class="modal fade" id="recordDetailsModal" tabindex="-1" aria-labelledby="recordDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordDetailsModalLabel">Prediction Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Personal Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Age:</th>
                                    <td id="modal-age"></td>
                                </tr>
                                <tr>
                                    <th>Sex:</th>
                                    <td id="modal-sex"></td>
                                </tr>
                                <tr>
                                    <th>Education:</th>
                                    <td id="modal-education"></td>
                                </tr>
                                <tr>
                                    <th>BMI:</th>
                                    <td id="modal-bmi"></td>
                                </tr>
                            </table>
                            
                            <h6 class="mt-3">Medical History</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Previous Stroke:</th>
                                    <td id="modal-stroke"></td>
                                </tr>
                                <tr>
                                    <th>Hypertension:</th>
                                    <td id="modal-hypertension"></td>
                                </tr>
                                <tr>
                                    <th>Diabetes:</th>
                                    <td id="modal-diabetes"></td>
                                </tr>
                                <tr>
                                    <th>BP Medication:</th>
                                    <td id="modal-bpmeds"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Clinical Measurements</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Systolic BP:</th>
                                    <td id="modal-sysbp"></td>
                                </tr>
                                <tr>
                                    <th>Diastolic BP:</th>
                                    <td id="modal-diabp"></td>
                                </tr>
                                <tr>
                                    <th>Total Cholesterol:</th>
                                    <td id="modal-cholesterol"></td>
                                </tr>
                                <tr>
                                    <th>Heart Rate:</th>
                                    <td id="modal-heartrate"></td>
                                </tr>
                                <tr>
                                    <th>Glucose:</th>
                                    <td id="modal-glucose"></td>
                                </tr>
                            </table>
                            
                            <h6 class="mt-3">Lifestyle Factors</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Smoking Status:</th>
                                    <td id="modal-smoking"></td>
                                </tr>
                                <tr>
                                    <th>Cigarettes Per Day:</th>
                                    <td id="modal-cigarettes"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Prediction Result</h6>
                        <div class="alert" id="modal-result-alert">
                            <h5 id="modal-result-message"></h5>
                            <p id="modal-result-probability"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clear History Confirmation Modal -->
    <div class="modal fade" id="clearHistoryModal" tabindex="-1" aria-labelledby="clearHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearHistoryModalLabel">Confirm Clear History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to clear all prediction history? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmClearBtn">Clear History</button>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="mt-5 text-center text-muted">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5><i class="bi bi-heart-pulse"></i> Heart Disease Prediction</h5>
                    <p class="small">A machine learning tool to predict 10-year risk of coronary heart disease</p>
                </div>
                <div class="col-md-4">
                    <h5><i class="bi bi-shield-check"></i> Disclaimer</h5>
                    <p class="small">This tool is for educational purposes only and should not replace medical advice</p>
                </div>
                <div class="col-md-4">
                    <h5><i class="bi bi-link-45deg"></i> Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="/about" class="text-muted">About</a></li>
                        <li><a href="/visualizations" class="text-muted">Data Insights</a></li>
                        <li><a href="/" class="text-muted">Prediction Tool</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p>&copy; 2023 Heart Disease Prediction Tool</p>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set progress bar widths dynamically based on data-probability attribute
            const progressBars = document.querySelectorAll('.progress-bar');
            progressBars.forEach(bar => {
                const probability = parseFloat(bar.getAttribute('data-probability')) || 0;
                bar.style.width = `${probability}%`;
                bar.setAttribute('aria-valuenow', probability.toFixed(1));
            });
            // Handle view details button clicks
            const viewDetailsBtns = document.querySelectorAll('.view-details-btn');
            viewDetailsBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const record = JSON.parse(this.getAttribute('data-record'));
                    
                    // Fill modal with record data
                    document.getElementById('modal-age').textContent = record.input_data.age;
                    document.getElementById('modal-sex').textContent = record.input_data.sex === 1 ? 'Male' : 'Female';
                    
                    // Education level
                    const educationLevels = {
                        '1': 'Some High School',
                        '2': 'High School or GED',
                        '3': 'Some College or Vocational School',
                        '4': 'College'
                    };
                    document.getElementById('modal-education').textContent = 
                        record.input_data.education ? educationLevels[record.input_data.education] : 'Not specified';
                    
                    document.getElementById('modal-bmi').textContent = 
                        record.input_data.BMI ? `${record.input_data.BMI} kg/m²` : 'Not specified';
                    
                    // Medical history
                    document.getElementById('modal-stroke').textContent = record.input_data.prevalentStroke === 1 ? 'Yes' : 'No';
                    document.getElementById('modal-hypertension').textContent = record.input_data.prevalentHyp === 1 ? 'Yes' : 'No';
                    document.getElementById('modal-diabetes').textContent = record.input_data.diabetes === 1 ? 'Yes' : 'No';
                    document.getElementById('modal-bpmeds').textContent = record.input_data.BPMeds === 1 ? 'Yes' : 'No';
                    
                    // Clinical measurements
                    document.getElementById('modal-sysbp').textContent = `${record.input_data.sysBP} mmHg`;
                    document.getElementById('modal-diabp').textContent = `${record.input_data.diaBP} mmHg`;
                    document.getElementById('modal-cholesterol').textContent = `${record.input_data.totChol} mg/dL`;
                    document.getElementById('modal-heartrate').textContent = `${record.input_data.heartRate} bpm`;
                    document.getElementById('modal-glucose').textContent = 
                        record.input_data.glucose ? `${record.input_data.glucose} mg/dL` : 'Not specified';
                    
                    // Lifestyle factors
                    document.getElementById('modal-smoking').textContent = record.input_data.is_smoking === 1 ? 'Smoker' : 'Non-smoker';
                    document.getElementById('modal-cigarettes').textContent = 
                        record.input_data.is_smoking === 1 ? `${record.input_data.cigsPerDay} per day` : 'N/A';
                    
                    // Prediction result
                    const resultAlert = document.getElementById('modal-result-alert');
                    const resultMessage = document.getElementById('modal-result-message');
                    const resultProbability = document.getElementById('modal-result-probability');
                    
                    if (record.prediction === 1) {
                        resultAlert.className = 'alert alert-danger';
                        resultMessage.textContent = 'High risk of heart disease in 10 years';
                    } else {
                        resultAlert.className = 'alert alert-success';
                        resultMessage.textContent = 'Low risk of heart disease in 10 years';
                    }
                    
                    resultProbability.textContent = `Probability: ${(record.probability * 100).toFixed(2)}%`;
                });
            });
            
            // Handle clear history button
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', function() {
                    const clearHistoryModal = new bootstrap.Modal(document.getElementById('clearHistoryModal'));
                    clearHistoryModal.show();
                });
            }
            
            // Handle confirm clear button
            const confirmClearBtn = document.getElementById('confirmClearBtn');
            if (confirmClearBtn) {
                confirmClearBtn.addEventListener('click', function() {
                    // Make an API call to clear the history
                    fetch('/clear_history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert('Failed to clear history. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while clearing history.');
                    });
                });
            }
        });
    </script>
</body>
</html>